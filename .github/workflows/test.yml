name: test
on:
  pull_request:
    branches:
      - main
    paths:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - ".goreleaser.yml"
      - "plugin.yaml"

permissions:
  contents: read
  pull-requests: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest


    steps:

      - name: "checkout"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.3

      # - name: Docs
      #   run: |
      #     make docs
      #     if [[ $(git status --porcelain) ]]; then
      #       echo "Documentation is out of date, please update it"
      #       git diff
      #       exit 1
      #     fi

      - name: Run Docker Registry
        run: |
          mkdir -p  reg/certs reg/auth
          cd reg
          echo -n "reg_username:$2y$05$rG1Q4zETkJMkVU6MzFmKeeXV737BjB5SsV/VDe.LB5Ho3eBb0.u42" > ./auth/htpasswd
          docker run -d -p 5000:5000 --name registry \
            -v ./auth:/auth \
            -e REGISTRY_HTTP_ADDR=0.0.0.0:5000 \
            -e REGISTRY_AUTH=htpasswd \
            -e REGISTRY_AUTH_HTPASSWD_REALM="Registry Realm" \
            -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
            registry:2

          sleep 5
          curl -u reg_username:reg_password http://localhost:5000/v2/_catalog --insecure -v
          docker login -u reg_username -p reg_password localhost:5000

      - name: run unit test
        run: |
          make test


          docker run registry:2 -Bbn reg_username reg_password
